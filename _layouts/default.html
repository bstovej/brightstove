<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page.title | default: site.title }}</title>
    <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    {% if site.umami_website_id %}
    <script defer src="https://cloud.umami.is/script.js" data-website-id="{{ site.umami_website_id }}"></script>
    {% endif %}
</head>
<body>
    <header class="site-header">
        <div class="wrapper">
            <a class="site-title" href="{{ '/' | relative_url }}">{{ site.title }}</a>
            <p class="site-description">{{ site.description }}</p>
            <nav class="site-nav">
                <a href="{{ '/' | relative_url }}">Home</a>
                <a href="{{ '/categories' | relative_url }}">Categories</a>
                <a href="{{ '/archives' | relative_url }}">Archives</a>
                <a href="{{ '/about' | relative_url }}">About</a>
            </nav>
        </div>
    </header>

    <main class="page-content" aria-label="Content">
        <div class="wrapper site-main-wrapper">
            <div class="content-area">
                {{ content }}
            </div>
            
            <aside class="sidebar">
                <div class="widget">
                    <h3 class="widget-title">Search</h3>
                    <div id="search-container">
                        <input type="text" id="search-input" placeholder="Search posts...">
                        <ul id="results-container"></ul>
                    </div>
                </div>

                <div class="widget">
                    <p><b><a href="{{ '/about' | relative_url }}">About Bright Stove</a></b></p>
                </div>

                <div class="widget">
                    <div id="sidebar-calendar" class="sidebar-calendar-container"></div>
                    
                    <script>
                        const postData = {
                            {% for post in site.posts %}
                            "{{ post.date | date: '%Y-%m-%d' }}": {
                                "url": "{{ post.url | relative_url }}",
                                "title": "{{ post.title | escape }}"
                            }{% unless forloop.last %},{% endunless %}
                            {% endfor %}
                        };

                        const archivesUrl = "{{ '/archives/' | relative_url }}";
                        let currentViewDate = new Date();
                        const today = new Date();

                        function renderSidebarCalendar(date) {
                            const year = date.getFullYear();
                            const month = date.getMonth();
                            const container = document.getElementById('sidebar-calendar');
                            
                            const monthName = date.toLocaleString('default', { month: 'long' });
                            const firstDay = new Date(year, month, 1).getDay();
                            const daysInMonth = new Date(year, month + 1, 0).getDate();
                            
                            const isCurrentYear = year === today.getFullYear();
                            const isCurrentMonth = isCurrentYear && month === today.getMonth();

                            let html = `
                                <div class="calendar-nav">
                                    <div class="nav-row year-nav">
                                        <span class="nav-btn" onclick="changeYear(-1)">«</span>
                                        <a href="${archivesUrl}#${year}" class="nav-label">${year}</a>
                                        <span class="nav-btn ${isCurrentYear ? 'disabled' : ''}" onclick="${isCurrentYear ? '' : 'changeYear(1)'}">»</span>
                                    </div>
                                    <div class="nav-row month-nav">
                                        <span class="nav-btn" onclick="changeMonth(-1)">‹</span>
                                        <a href="${archivesUrl}#${monthName}-${year}" class="nav-label">${monthName}</a>
                                        <span class="nav-btn ${isCurrentMonth ? 'disabled' : ''}" onclick="${isCurrentMonth ? '' : 'changeMonth(1)'}">›</span>
                                    </div>
                                </div>
                                <table class="sidebar-calendar-table">
                                    <thead>
                                        <tr>
                                            <th>Su</th><th>Mo</th><th>Tu</th><th>We</th><th>Th</th><th>Fr</th><th>Sa</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;

                            let day = 1;
                            for (let i = 0; i < 6; i++) {
                                html += '<tr>';
                                for (let j = 0; j < 7; j++) {
                                    if (i === 0 && j < firstDay) {
                                        html += '<td></td>';
                                    } else if (day > daysInMonth) {
                                        html += '<td></td>';
                                    } else {
                                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                        if (postData[dateStr]) {
                                            html += `<td class="day has-post"><a href="${postData[dateStr].url}" title="${postData[dateStr].title}">${day}</a></td>`;
                                        } else {
                                            html += `<td class="day">${day}</td>`;
                                        }
                                        day++;
                                    }
                                }
                                html += '</tr>';
                                if (day > daysInMonth) break;
                            }
                            html += '</tbody></table>';
                            container.innerHTML = html;
                        }

                        window.changeYear = function(delta) {
                            let newYear = currentViewDate.getFullYear() + delta;
                            if (newYear > today.getFullYear()) return;
                            currentViewDate.setFullYear(newYear);
                            if (newYear === today.getFullYear() && currentViewDate.getMonth() > today.getMonth()) {
                                currentViewDate.setMonth(today.getMonth());
                            }
                            renderSidebarCalendar(currentViewDate);
                        };

                        window.changeMonth = function(delta) {
                            let targetDate = new Date(currentViewDate.getFullYear(), currentViewDate.getMonth() + delta, 1);
                            if (targetDate > today) return;
                            currentViewDate = targetDate;
                            renderSidebarCalendar(currentViewDate);
                        };

                        renderSidebarCalendar(currentViewDate);
                    </script>
                </div>

                <div class="widget">
                    <h3 class="widget-title">Published Books</h3>
                    <div class="book-widget">
                        <a href="https://tinyurl.com/54pmw34z" target="_blank">
                            <img src="{{ '/assets/images/responsivesecuritybookcover.jpg' | relative_url }}" alt="Responsive Security: Be Ready to Be Secure" class="sidebar-book-img">
                        </a>
                        <a href="https://book.douban.com/subject/30214621/" target="_blank">
                            <img src="{{ '/assets/images/rs_cn_cover.jpg' | relative_url }}" alt="《响应式安全：构建企业信息安全体系》" class="sidebar-book-img">
                        </a>
                    </div>
                </div>

                <div class="widget">
                    <h3 class="widget-title">Recent Posts</h3>
                    <ul>
                        {% assign sorted_posts = site.posts | sort: "date" | reverse %}
                        {% for post in sorted_posts limit:5 %}
                        <li><a href="{{ post.url | relative_url }}">{{ post.title }}</a></li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="widget">
                    <h3 class="widget-title"><a href="{{ '/categories' | relative_url }}">Categories</a></h3>
                    <ul>
                        {% assign categories = site.categories | sort %}
                        {% for category in categories %}
                        <li><a href="{{ '/categories' | relative_url }}#{{ category[0] | slugify }}">{{ category[0] }}</a> ({{ category[1] | size }})</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="widget">
                    <h3 class="widget-title"><a href="{{ '/archives' | relative_url }}">Archives</a></h3>
                    <ul>
                        {% assign postsByMonth = site.posts | group_by_exp: "post", "post.date | date: '%B %Y'" %}
                        {% for month in postsByMonth limit:12 %}
                        <li><a href="{{ '/archives' | relative_url }}#{{ month.name | slugify }}">{{ month.name }}</a> ({{ month.items | size }})</li>
                        {% endfor %}
                    </ul>
                </div>
            </aside>
        </div>
    </main>

    <footer class="site-footer">
        <div class="wrapper">
            <p>&copy; {{ site.time | date: '%Y' }} {{ site.title }}</p>
        </div>
    </footer>

    <!-- Search Script -->
    <script src="https://unpkg.com/simple-jekyll-search@latest/dest/simple-jekyll-search.min.js"></script>
    <script>
        SimpleJekyllSearch({
            searchInput: document.getElementById('search-input'),
            resultsContainer: document.getElementById('results-container'),
            json: "{{ '/search.json' | relative_url }}",
            searchResultTemplate: '<li><a href="{url}">{title}</a><br><small>{date}</small></li>',
            noResultsText: '<li>No results found</li>',
            limit: 10,
            fuzzy: false
        });
    </script>
</body>
</html>
